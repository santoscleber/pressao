<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Controle de Press√£o Arterial</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@sgratzl/chartjs-chart-boxplot"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
  font-family:Segoe UI,Tahoma,Verdana,sans-serif;
  background:linear-gradient(135deg,#667eea,#764ba2);
  min-height:100vh;
  padding:20px;
}
.container{max-width:1200px;margin:auto}
header{text-align:center;color:#fff;margin-bottom:30px}
.card{
  background:#fff;
  border-radius:15px;
  padding:25px;
  margin-bottom:20px;
  box-shadow:0 10px 30px rgba(0,0,0,.2)
}
.input-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
  gap:15px;
  margin-bottom:20px
}
label{font-weight:600;margin-bottom:6px;display:block}
input{
  padding:12px;
  border:2px solid #e0e0e0;
  border-radius:8px;
  font-size:16px;
  width:100%
}
button{
  width:100%;
  padding:15px;
  background:linear-gradient(135deg,#667eea,#764ba2);
  color:#fff;
  border:none;
  border-radius:8px;
  font-size:16px;
  cursor:pointer;
  transition:transform 0.2s
}
button:hover{transform:translateY(-2px)}
.tabs{display:flex;gap:10px}
.tab-btn{
  padding:8px 20px;
  background:#eee;
  border-radius:20px;
  border:none;
  cursor:pointer;
  width:auto
}
.tab-btn.active{
  background:linear-gradient(135deg,#667eea,#764ba2);
  color:#fff
}
.chart-container{height:400px;position:relative}
.stats-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
  gap:15px
}
.stat-card{
  background:linear-gradient(135deg,#667eea,#764ba2);
  color:#fff;
  padding:20px;
  border-radius:10px;
  text-align:center
}
.stat-label{font-size:14px;opacity:0.9;margin-bottom:8px}
.stat-value{font-size:28px;font-weight:bold}
.history-table{
  width:100%;
  border-collapse:collapse;
  margin-top:15px
}
.history-table th{
  background:#f5f5f5;
  padding:12px;
  text-align:left;
  font-weight:600
}
.history-table td{
  padding:12px;
  border-bottom:1px solid #e0e0e0
}
.btn-small{
  padding:6px 12px;
  margin:0 3px;
  font-size:14px;
  border-radius:5px;
  cursor:pointer;
  border:none;
  color:#fff
}
.btn-edit{background:#f59e0b}
.btn-delete{background:#ef4444}
.btn-export{
  background:#10b981;
  width:auto;
  padding:10px 20px;
  display:inline-block;
  margin-right:10px
}
.export-buttons{margin-bottom:15px}
</style>
</head>

<body>
<div class="container">

<header>
  <h1>üìä Controle de Press√£o Arterial</h1>
  <p>Eliana Mendes de Assis</p>
</header>

<div class="card">
  <h3 style="text-align:center">Nova Medi√ß√£o</h3>
  <div class="input-grid">
    <div>
      <label>Sist√≥lica (mmHg)</label>
      <input type="number" id="sistolica" placeholder="120">
    </div>
    <div>
      <label>Diast√≥lica (mmHg)</label>
      <input type="number" id="diastolica" placeholder="80">
    </div>
    <div>
      <label>Data e Hora</label>
      <input type="datetime-local" id="datahora">
    </div>
  </div>
  <button onclick="salvar()">Salvar Medi√ß√£o</button>
</div>

<div class="card">
  <h3 style="text-align:center">Gr√°fico de Linha</h3>
  <div class="chart-container">
    <canvas id="graficoLinha"></canvas>
  </div>
</div>

<div class="card">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
    <h3 style="flex:1;text-align:center">BoxPlot</h3>
    <div class="tabs">
      <button class="tab-btn active" onclick="mudarPeriodo('dia',this)">Dia</button>
      <button class="tab-btn" onclick="mudarPeriodo('semana',this)">Semana</button>
      <button class="tab-btn" onclick="mudarPeriodo('mes',this)">M√™s</button>
    </div>
  </div>
  <div class="chart-container">
    <canvas id="graficoBox"></canvas>
  </div>
</div>

<div class="card">
  <h3 style="text-align:center">Estat√≠sticas</h3>
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-label">M√©dia Sist√≥lica</div>
      <div class="stat-value" id="mediaSis">--</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">M√©dia Diast√≥lica</div>
      <div class="stat-value" id="mediaDia">--</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">M√°xima</div>
      <div class="stat-value" id="maxima">--</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">M√≠nima</div>
      <div class="stat-value" id="minima">--</div>
    </div>
  </div>
</div>

<div class="card">
  <div style="text-align:center;margin-bottom:15px">
    <h3 style="display:inline-block;margin-right:20px">Hist√≥rico de Medi√ß√µes</h3>
    <div class="export-buttons">
      <button class="btn-export" onclick="exportarCSV()">üì• Exportar CSV</button>
      <button class="btn-export" onclick="exportarTXT()">üìÑ Exportar TXT</button>
    </div>
  </div>
  <div id="tabelaHistorico"></div>
</div>

</div>

<script>
let dados = [];
let periodoBox = 'dia';
let editandoIndex = -1;

// Inicializar dados do storage
async function carregarDados() {
  try {
    const result = await window.storage.get('pressao-dados');
    if (result && result.value) {
      dados = JSON.parse(result.value);
    }
  } catch (error) {
    console.log('Nenhum dado anterior encontrado');
  }
}

async function salvarDados() {
  try {
    await window.storage.set('pressao-dados', JSON.stringify(dados));
  } catch (error) {
    console.error('Erro ao salvar:', error);
  }
}

/* ---------- ORDENA√á√ÉO ---------- */
function ordenarDados() {
  dados.sort((a,b)=>new Date(a.data)-new Date(b.data));
}

/* ---------- GR√ÅFICO LINHA ---------- */
const graficoLinha = new Chart(document.getElementById('graficoLinha'),{
  type:'line',
  data:{labels:[],datasets:[
    {label:'Sist√≥lica',data:[],borderColor:'#ef4444',tension:.4,fill:false},
    {label:'Diast√≥lica',data:[],borderColor:'#3b82f6',tension:.4,fill:false}
  ]},
  options:{
    responsive:true,
    maintainAspectRatio:false,
    plugins:{
      legend:{display:true}
    }
  }
});

/* ---------- GR√ÅFICO BOX ---------- */
const graficoBox = new Chart(document.getElementById('graficoBox'),{
  type:'boxplot',
  data:{labels:[],datasets:[]},
  options:{
    responsive:true,
    maintainAspectRatio:false,
    plugins:{
      legend:{display:true}
    }
  }
});

/* ---------- AGRUPAMENTO CRONOL√ìGICO ---------- */
function agruparPorPeriodo() {
  const grupos = {};
  dados.forEach(d=>{
    const dt = new Date(d.data);
    let chave, ordem;

    if(periodoBox==='dia'){
      ordem=new Date(dt.getFullYear(),dt.getMonth(),dt.getDate());
      chave=ordem.toLocaleDateString('pt-BR');
    }
    if(periodoBox==='semana'){
      const ini=new Date(dt);
      ini.setDate(dt.getDate()-dt.getDay());
      ordem=new Date(ini.getFullYear(),ini.getMonth(),ini.getDate());
      chave='Semana '+ordem.toLocaleDateString('pt-BR');
    }
    if(periodoBox==='mes'){
      ordem=new Date(dt.getFullYear(),dt.getMonth(),1);
      chave=ordem.toLocaleDateString('pt-BR',{month:'long',year:'numeric'});
    }

    if(!grupos[chave])grupos[chave]={ordem,sis:[],dia:[]};
    grupos[chave].sis.push(+d.sis);
    grupos[chave].dia.push(+d.dia);
  });
  return grupos;
}

/* ---------- ATUALIZA√á√ïES ---------- */
function atualizarLinha(){
  ordenarDados();
  graficoLinha.data.labels=dados.map(d=>{
    const dt=new Date(d.data);
    return dt.toLocaleDateString('pt-BR')+' '+dt.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});
  });
  graficoLinha.data.datasets[0].data=dados.map(d=>+d.sis);
  graficoLinha.data.datasets[1].data=dados.map(d=>+d.dia);
  graficoLinha.update();
}

function atualizarBox(){
  ordenarDados();
  const g=agruparPorPeriodo();
  const labels=Object.entries(g)
    .sort((a,b)=>a[1].ordem-b[1].ordem)
    .map(e=>e[0]);

  graficoBox.data.labels=labels;
  graficoBox.data.datasets=[
    {label:'Sist√≥lica',data:labels.map(l=>g[l].sis),backgroundColor:'rgba(239,68,68,.5)',borderColor:'#ef4444',borderWidth:2},
    {label:'Diast√≥lica',data:labels.map(l=>g[l].dia),backgroundColor:'rgba(59,130,246,.5)',borderColor:'#3b82f6',borderWidth:2}
  ];
  graficoBox.update();
}

/* ---------- ESTAT√çSTICAS ---------- */
function atualizarEstatisticas(){
  if(dados.length===0){
    mediaSis.textContent=mediaDia.textContent=maxima.textContent=minima.textContent='--';
    return;
  }
  
  const sis = dados.map(d=>+d.sis);
  const dia = dados.map(d=>+d.dia);
  
  const mediaSisVal = (sis.reduce((a,b)=>a+b,0)/sis.length).toFixed(0);
  const mediaDiaVal = (dia.reduce((a,b)=>a+b,0)/dia.length).toFixed(0);
  const maxSis = Math.max(...sis);
  const maxDia = Math.max(...dia);
  const minSis = Math.min(...sis);
  const minDia = Math.min(...dia);
  
  mediaSis.textContent = mediaSisVal + ' mmHg';
  mediaDia.textContent = mediaDiaVal + ' mmHg';
  maxima.textContent = maxSis + '/' + maxDia;
  minima.textContent = minSis + '/' + minDia;
}

/* ---------- TABELA HIST√ìRICO ---------- */
function atualizarTabela(){
  const dadosOrdenados = [...dados].sort((a,b)=>new Date(b.data)-new Date(a.data));
  
  let html = '<table class="history-table"><thead><tr>';
  html += '<th>Data/Hora</th><th>Sist√≥lica</th><th>Diast√≥lica</th><th>A√ß√µes</th>';
  html += '</tr></thead><tbody>';
  
  if(dadosOrdenados.length===0){
    html += '<tr><td colspan="4" style="text-align:center;color:#999">Nenhuma medi√ß√£o registrada</td></tr>';
  } else {
    dadosOrdenados.forEach((d,i)=>{
      const dt = new Date(d.data);
      const dataFormatada = dt.toLocaleDateString('pt-BR')+' '+dt.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});
      const indexOriginal = dados.findIndex(item=>item.data===d.data&&item.sis===d.sis&&item.dia===d.dia);
      
      html += '<tr>';
      html += '<td>'+dataFormatada+'</td>';
      html += '<td>'+d.sis+' mmHg</td>';
      html += '<td>'+d.dia+' mmHg</td>';
      html += '<td>';
      html += '<button class="btn-small btn-edit" onclick="editarMedicao('+indexOriginal+')">‚úèÔ∏è Editar</button>';
      html += '<button class="btn-small btn-delete" onclick="excluirMedicao('+indexOriginal+')">üóëÔ∏è Excluir</button>';
      html += '</td>';
      html += '</tr>';
    });
  }
  
  html += '</tbody></table>';
  tabelaHistorico.innerHTML = html;
}

/* ---------- EDITAR/EXCLUIR ---------- */
function editarMedicao(index){
  editandoIndex = index;
  const d = dados[index];
  sistolica.value = d.sis;
  diastolica.value = d.dia;
  datahora.value = d.data;
  document.querySelector('.card:nth-child(3) h3').textContent = 'Editar Medi√ß√£o';
  document.querySelector('.card:nth-child(3) button').textContent = 'Atualizar Medi√ß√£o';
  window.scrollTo({top:0,behavior:'smooth'});
}

function excluirMedicao(index){
  if(confirm('Deseja realmente excluir esta medi√ß√£o?')){
    dados.splice(index,1);
    salvarDados();
    atualizarTudo();
  }
}

/* ---------- EXPORTAR ---------- */
function exportarCSV(){
  if(dados.length===0){
    alert('N√£o h√° dados para exportar');
    return;
  }
  
  let csv = 'Data/Hora,Sist√≥lica (mmHg),Diast√≥lica (mmHg)\n';
  dados.forEach(d=>{
    const dt = new Date(d.data);
    const dataFormatada = dt.toLocaleDateString('pt-BR')+' '+dt.toLocaleTimeString('pt-BR');
    csv += dataFormatada+','+d.sis+','+d.dia+'\n';
  });
  
  const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'pressao_arterial_'+new Date().toISOString().slice(0,10)+'.csv';
  link.click();
}

function exportarTXT(){
  if(dados.length===0){
    alert('N√£o h√° dados para exportar');
    return;
  }
  
  let conteudo = 'CONTROLE DE PRESS√ÉO ARTERIAL\n';
  conteudo += 'Eliana Mendes de Assis\n';
  conteudo += 'Relat√≥rio gerado em: '+new Date().toLocaleString('pt-BR')+'\n\n';
  conteudo += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
  
  const sis = dados.map(d=>+d.sis);
  const dia = dados.map(d=>+d.dia);
  const mediaSisVal = (sis.reduce((a,b)=>a+b,0)/sis.length).toFixed(0);
  const mediaDiaVal = (dia.reduce((a,b)=>a+b,0)/dia.length).toFixed(0);
  
  conteudo += 'ESTAT√çSTICAS:\n';
  conteudo += '‚Ä¢ M√©dia: '+mediaSisVal+'/'+mediaDiaVal+' mmHg\n';
  conteudo += '‚Ä¢ M√°xima: '+Math.max(...sis)+'/'+Math.max(...dia)+' mmHg\n';
  conteudo += '‚Ä¢ M√≠nima: '+Math.min(...sis)+'/'+Math.min(...dia)+' mmHg\n';
  conteudo += '‚Ä¢ Total de medi√ß√µes: '+dados.length+'\n\n';
  conteudo += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
  
  conteudo += 'HIST√ìRICO DE MEDI√á√ïES:\n\n';
  const dadosOrdenados = [...dados].sort((a,b)=>new Date(b.data)-new Date(a.data));
  dadosOrdenados.forEach((d,i)=>{
    const dt = new Date(d.data);
    const dataFormatada = dt.toLocaleDateString('pt-BR')+' '+dt.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});
    conteudo += (i+1)+'. '+dataFormatada+' - '+d.sis+'/'+d.dia+' mmHg\n';
  });
  
  const blob = new Blob([conteudo],{type:'text/plain;charset=utf-8;'});
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'relatorio_pressao_'+new Date().toISOString().slice(0,10)+'.txt';
  link.click();
}

function atualizarTudo(){
  atualizarLinha();
  atualizarBox();
  atualizarEstatisticas();
  atualizarTabela();
}

/* ---------- CONTROLES ---------- */
function mudarPeriodo(p,btn){
  periodoBox=p;
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  atualizarBox();
}

async function salvar(){
  const sis=sistolica.value;
  const dia=diastolica.value;
  const data=datahora.value;
  if(!sis||!dia||!data)return alert('Preencha todos os campos');
  
  if(editandoIndex>=0){
    dados[editandoIndex]={sis,dia,data};
    editandoIndex=-1;
    document.querySelector('.card:nth-child(3) h3').textContent='Nova Medi√ß√£o';
    document.querySelector('.card:nth-child(3) button').textContent='Salvar Medi√ß√£o';
  } else {
    dados.push({sis,dia,data});
  }
  
  await salvarDados();
  atualizarTudo();
  sistolica.value=diastolica.value='';
  alert(editandoIndex>=0?'Medi√ß√£o atualizada!':'Medi√ß√£o salva com sucesso!');
}

/* ---------- INIT ---------- */
async function init() {
  await carregarDados();
  atualizarTudo();
  
  // Definir data/hora atual como padr√£o
  const agora = new Date();
  agora.setMinutes(agora.getMinutes() - agora.getTimezoneOffset());
  datahora.value = agora.toISOString().slice(0,16);
}

init();
</script>
</body>
</html>
